
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>WINTERHALDER ET AL.(2005) - 7-dimension unbalanced random independent variables UNBALANCED RANDOM INDEPENDENT VARIABLES</title><meta name="generator" content="MATLAB 9.8"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-10-26"><meta name="DC.source" content="winterhalder2005_variant.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>WINTERHALDER ET AL.(2005) - 7-dimension unbalanced random independent variables UNBALANCED RANDOM INDEPENDENT VARIABLES</h1><!--introduction--><p>Description:</p><p>Expanded to seven variables and modified to consider unbalanced variances with idea borrowed from:  Winterhalder et al. Comparison of linear signal processing techniques to  infer directed interactions in multivariate neural systems.  <i>Signal Processing</i> 85:2137--2160, 2005. <a href="http://dx.doi.org/10.1016/j.sigpro.2005.07.011">http://dx.doi.org/10.1016/j.sigpro.2005.07.011</a></p><p>Example: Seven random independent variables with unbalanced variances. Variant of Random Independent Process with 7 variables') with following variances:</p><p><img src="winterhalder2005_variant_eq03245793016271417325.png" alt="$\sigma_1^2=\sigma_3^2=250,000; \sigma_2^2=\sigma_4^2=\sigma_5^2=\sigma_6^2=\sigma_7^2=1$"></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">See also: mvar, mvarresidue, asymp_pdc, asymp_dtf, gct_alg,</a></li><li><a href="#3">Data sample generation</a></li><li><a href="#4">Data generation function:</a></li><li><a href="#5">PDC/DTF  estimation and analysis parameters</a></li><li><a href="#6">Data pre-processing: detrending and standardization options</a></li><li><a href="#7">MVAR model estimation</a></li><li><a href="#8">Testing the adequacy of MAR model fitting through Portmanteau test</a></li><li><a href="#9">Granger causality test (GCT) and instantaneous GCT</a></li><li><a href="#10">PDC, threshold and confidence interval calculations.</a></li><li><a href="#12">Plotting options set up, mostly cosmetic for xplot.m routine:</a></li><li><a href="#13">Original PDC plot</a></li><li><a href="#15">PDC p-values plot</a></li><li><a href="#17">Information PDC estimation and analysis parameters</a></li><li><a href="#18">Information PDC plot</a></li><li><a href="#19">Remarks on false-positive connectivity detection ratio:</a></li><li><a href="#20">General remarks about xplot features:</a></li></ul></div><h2 id="1">See also: mvar, mvarresidue, asymp_pdc, asymp_dtf, gct_alg,</h2><pre>            igct_alg, xplot, xplot_pvalues</pre><pre class="codeinput"><span class="comment">% (C) Koichi Sameshima &amp; Luiz A. Baccal&aacute;, 2022.</span>
<span class="comment">% See file license.txt in installation directory for licensing terms.</span>
</pre><h2 id="3">Data sample generation</h2><pre class="codeinput">clear; clc; format <span class="string">compact</span>; format <span class="string">short</span>

flgPrintScreen = <span class="string">'Screen'</span>; <span class="comment">%'Screen' or  'Print'</span>

nBurnIn = 1000;    <span class="comment">% number of points discarded at beginning of simulation</span>
nPoints  = 5000;    <span class="comment">% number of analyzed samples points</span>

alpha  = 0.05;  <span class="comment">% Significance level for PDC/DTF null hypothesis test</span>
</pre><h2 id="4">Data generation function:</h2><pre class="codeinput">u = fwinterhalder2005_variant(nPoints, nBurnIn);

chLabels = {<span class="string">'x_1'</span>;<span class="string">'x_2'</span>;<span class="string">'x_3'</span>;<span class="string">'x_4'</span>;<span class="string">'x_5'</span>;<span class="string">'x_6'</span>;<span class="string">'x_7'</span>};<span class="comment">%chLabels = [];</span>
fs = 1; <span class="comment">% Normalized sampling frequency</span>
</pre><pre class="codeoutput">======================================================================
       Winterhalder et al. Signal Processing. 85:2137--60, 2005
        Variant of Random Independent Process with 7 variables
 [sigma1=500|sigma2=1|sigma3=500|sigma4=1|sigma5=1|sigma6=1|sigma7=1]
======================================================================
</pre><h2 id="5">PDC/DTF  estimation and analysis parameters</h2><pre class="codeinput"><span class="comment">% Common routine segment for all examples</span>
</pre><h2 id="6">Data pre-processing: detrending and standardization options</h2><pre class="codeinput">flgDetrend = 1;     <span class="comment">% 1: Detrending the data set</span>
flgStandardize = 0; <span class="comment">% 0: No standardization</span>

<span class="comment">% Checking data dimension</span>
[nChannels,nSegLength] = size(u);
<span class="keyword">if</span> nChannels &gt; nSegLength
   u = u.';
   [nChannels,nSegLength] = size(u);
<span class="keyword">end</span>

<span class="comment">% Detrending</span>
<span class="keyword">if</span> flgDetrend
   <span class="keyword">for</span> i = 1:nChannels, u(i,:) = detrend(u(i,:)); <span class="keyword">end</span>
   disp(<span class="string">'Time series were detrended.'</span>);
<span class="keyword">end</span>

<span class="comment">% Standardization</span>
<span class="keyword">if</span> flgStandardize
   <span class="keyword">for</span> i = 1:nChannels, u(i,:) = u(i,:)/std(u(i,:)); <span class="keyword">end</span>
   disp(<span class="string">'Time series were scale-standardized.'</span>);
<span class="keyword">end</span>;
</pre><pre class="codeoutput">Time series were detrended.
</pre><h2 id="7">MVAR model estimation</h2><pre class="codeinput">maxIP = 30;         <span class="comment">% maximum model order to consider.</span>
alg = 1;            <span class="comment">% 1 = Nutall-Strand MVAR estimation algorithm</span>
criterion = 1;      <span class="comment">% 1 = AIC, Akaike Information Criteria</span>

disp(<span class="string">'Running MVAR estimation and GCT analysis routines.'</span>)

[IP,pf,A,pb,B,ef,eb,vaic,Vaicv] = mvar(u,maxIP,alg,criterion);

disp([<span class="string">'Number of channels = '</span> int2str(nChannels) <span class="string">' with '</span> <span class="keyword">...</span>
    int2str(nSegLength) <span class="string">' data points; MAR model order = '</span> int2str(IP) <span class="string">'.'</span>]);
</pre><pre class="codeoutput">Running MVAR estimation and GCT analysis routines.
maxOrder limited to 30
IP=1  vaic=422447.654639
IP=2  vaic=422507.924155
 
Number of channels = 7 with 5000 data points; MAR model order = 1.
</pre><h2 id="8">Testing the adequacy of MAR model fitting through Portmanteau test</h2><pre class="codeinput">h = 20; <span class="comment">% testing lag value</span>
MVARadequacy_signif = 0.05; <span class="comment">% VAR model estimation adequacy significance</span>
                            <span class="comment">% level</span>
aValueMVAR = 1 - MVARadequacy_signif; <span class="comment">% Confidence value for the testing</span>

flgPrintResults = 1; <span class="comment">% flag = 1, print analysis results</span>

[Pass,Portmanteau,st,ths] = mvarresidue(ef,nSegLength,IP,aValueMVAR,h,<span class="keyword">...</span>
                                           flgPrintResults);
</pre><pre class="codeoutput">
====================================================================================================
                  MVAR RESIDURES TEST FOR WHITENESS
----------------------------------------------------------------------------------------------------
Good MAR model fitting! Residues white noise hypothesis NOT rejected.
Pass = 0.0326531
  st = 853.301
</pre><h2 id="9">Granger causality test (GCT) and instantaneous GCT</h2><pre class="codeinput">gct_signif  = alpha;  <span class="comment">% Granger causality test significance level</span>
igct_signif = alpha;  <span class="comment">% Instantaneous GCT significance level</span>



flgPrintResults = 1; <span class="comment">% Flag to control printing gct_alg.m results on command window.</span>

[Tr_gct, pValue_gct] = gct_alg(u,A,pf,gct_signif,flgPrintResults);
[Tr_igct, pValue_igct] = igct_alg(u,A,pf,igct_signif,flgPrintResults);
</pre><pre class="codeoutput">
====================================================================================================
                         GRANGER CAUSALITY TEST
----------------------------------------------------------------------------------------------------
Connectivity matrix:
   NaN     0     1     0     0     0     0
     0   NaN     0     0     0     0     0
     0     0   NaN     0     0     0     0
     0     0     0   NaN     0     1     0
     0     0     0     0   NaN     0     0
     0     0     0     0     0   NaN     0
     1     0     0     0     0     0   NaN

Granger causality test p-values:
       NaN    0.5481    0.0127    0.2955    0.5065    0.1448    0.3839
    0.5608       NaN    0.6056    0.5599    0.6256    0.7765    0.2689
    0.9094    0.5412       NaN    0.8774    0.8139    0.7239    0.3608
    0.1355    0.4279    0.1377       NaN    0.1889    0.0250    0.4278
    0.5655    0.8168    0.8848    0.3008       NaN    0.7311    0.3390
    0.1071    0.8169    0.0867    0.0829    0.1633       NaN    0.5090
    0.0323    0.8751    0.2192    0.2328    0.3602    0.8562       NaN

====================================================================================================
                  INSTANTANEOUS GRANGER CAUSALITY TEST
----------------------------------------------------------------------------------------------------
Instantaneous connectivity matrix:
   NaN     1     0     0     0     0     0
     1   NaN     0     0     0     0     0
     0     0   NaN     0     0     0     0
     0     0     0   NaN     0     0     0
     0     0     0     0   NaN     0     0
     0     0     0     0     0   NaN     0
     0     0     0     0     0     0   NaN

Instantaneous Granger Causality test p-values:
       NaN    0.0142    0.6654    0.5749    0.8886    0.7466    0.1714
    0.0142       NaN    0.9960    0.9906    0.1014    0.2776    0.7924
    0.6654    0.9960       NaN    0.3717    0.9967    0.8153    0.7484
    0.5749    0.9906    0.3717       NaN    0.8090    0.7841    0.4685
    0.8886    0.1014    0.9967    0.8090       NaN    0.2990    0.1889
    0.7466    0.2776    0.8153    0.7841    0.2990       NaN    0.7743
    0.1714    0.7924    0.7484    0.4685    0.1889    0.7743       NaN

&gt;&gt;&gt;&gt; There is a pair of channels with significant Instantaneous 
     Granger Causality.

====================================================================================================
</pre><h2 id="10">PDC, threshold and confidence interval calculations.</h2><pre class="codeinput">metric = <span class="string">'euc'</span>;  <span class="comment">% euc  = original PDC or DTF;</span>
                 <span class="comment">% diag = generalized PDC (gPDC) or DC;</span>
                 <span class="comment">% info = information PDC (iPDC) or iDTF.</span>

nFreqs = 128;   <span class="comment">% Number of frequency points to consider</span>
</pre><p>PDC analysis results are saved in <b>c</b> data structure. See asymp_pdc.m or issue</p><pre class="language-matlab">&gt;&gt; help asymp_pdc
</pre><p>command for more detail.</p><pre class="codeinput">c = asymp_pdc(u,A,pf,nFreqs,metric,alpha);
    c.Tragct = Tr_gct;
    c.pvaluesgct = pValue_gct;
</pre><h2 id="12">Plotting options set up, mostly cosmetic for xplot.m routine:</h2><pre class="codeinput"><span class="comment">% flgColor parameter for PDC matrix-layout plot.</span>
flgMax = <span class="string">'all'</span>;
flgSignifColor = 4; <span class="comment">% red + green</span>
flgScale = 3;       <span class="comment">% [0 1]/[0 .1]/[0 .01]</span>
flgColor = [0];   <span class="comment">% Plotting option for automatic scaling for small PDC</span>
                  <span class="comment">% values.</span>
                  <span class="comment">% if flgColor = 0, y-axis scale = [0 1]</span>
                  <span class="comment">% elseif flgColor = 1, xplot routine rescale</span>
                  <span class="comment">% the y-axis automatically according to following rules:</span>
                  <span class="comment">%   If .001&lt;= max(|PDC(f)|^2) &lt; .01 background-color = light-blue,</span>
                  <span class="comment">%                          so that y-axis scale = [0 .1]</span>
                  <span class="comment">%   elseif max(|PDC(f)|^2) &lt; .001 background-color = light-purple</span>
                  <span class="comment">%                          and y-axis = [0 .01].</span>
<span class="comment">%                [1 2 3 4 5 6 7]</span>
flgPrinting  =   [1 0 1 0 3 0 0];
<span class="comment">%       blue-line | | | | | | 7--Spectra (0: w/o; 1: Linear; 2: Log; 3: PDC2;</span>
<span class="comment">%                 | | | | | |      4: Linear normalized; 5: Log spectra + PDC2)</span>
<span class="comment">%            gray | | | | | 6--Coh2 (0: w/o Coh2; 1: w Coh2)</span>
<span class="comment">% green or purple | | | | 5--Print GCT results</span>
<span class="comment">%                 | | | 4--Plot confidence interval</span>
<span class="comment">%            red  | | 3--Significant PDC2|DTF2 in red lines</span>
<span class="comment">%    dashed-black | 2--Patnaik threshold level in black dashed-lines</span>
<span class="comment">%           green 1-- PDC2/DTF2 in green lines or black w/o statistics,</span>
<span class="comment">%                     See flgSignifColor bellow for line color selection.</span>

w_max=fs/2;
strID = <span class="string">'Winterhalder et al. Signal Processing 85:2137?60, 2005'</span>;
strTitle = [<span class="string">' Independent Gaussian Noise: \sigma_1=\sigma_3=500;'</span> <span class="keyword">...</span>
                           <span class="string">' \sigma_2 = \sigma_4 = \sigma_5 = 1'</span>];

flgScale = 2;
</pre><h2 id="13">Original PDC plot</h2><pre class="codeinput">[h,hxlabel,hylabel] = xplot(strID, c, <span class="keyword">...</span>
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale,flgMax,flgSignifColor);
xplot_title(alpha,metric,<span class="string">'PDC'</span>,strTitle);
</pre><img vspace="5" hspace="5" src="winterhalder2005_variant_01.png" alt=""> <p><b>Remarks on nonstandardized unbalanced noise analysis</b>:</p><div><ul><li>Note that in this example the time series were not standardized.</li><li>As a consequence, due to the high variance/power of channels   <img src="winterhalder2005_variant_eq06613056106014670631.png" alt="$x_1$"> and <img src="winterhalder2005_variant_eq14660336936512934444.png" alt="$x_3$">, <img src="winterhalder2005_variant_eq09556325088033023315.png" alt="$|{PDC}(\lambda)|^2$"> from other channels reaching these channels are   high, but   still in most cases not significant (represented by green lines).</li><li>The Patnaik thresholds plotted in dashed-lines may not be visible in these   subplots because their values are well above  upper limit of scale   range which is limited to [0 1] on y-axis.</li></ul></div><h2 id="15">PDC p-values plot</h2><pre class="codeinput">flgPrinting  =   [1 1 1 2 3 0 0];
[hp,hxlabel,hylabel] = xplot_pvalues(strID, c, <span class="keyword">...</span>
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale);
xplot_title(alpha,metric,<span class="string">'p-value PDC'</span>,strTitle);
</pre><img vspace="5" hspace="5" src="winterhalder2005_variant_02.png" alt=""> <p><b>Remarks on PDC p-values plots</b>:</p><div><ul><li>Obviously this will vary with the simulations, As we are dealing with 7 channels, there are 42 combinations of pair of channels. For random Gaussian processes, most likely one will see occasional false-positive inference in a rate proportional to the chosen alpha, which is 5% in this example. So one would expect roughly 42*0.05 false-positive cases in each simulation.</li><li>One can see above each subplot the Granger causality test p-value printed in green (not significant) or purple with dot (significant GCT) that should agree or be approximately equal in magnitude in most cases with the PDC p-values (our experience) plotted in frequency domain.</li></ul></div><h2 id="17">Information PDC estimation and analysis parameters</h2><p>If the metric is either 'diag' or 'info', the unbalanced noises are ruled out or scaled in their formulation as you can see in the information PDC calculation results shown bellow. Same consideration would apply for information PDC.</p><p>Information PDC analysis results are saved in <b>d</b> struct variable.</p><pre class="codeinput">metric = <span class="string">'info'</span>; <span class="comment">% info = information PDC (iPDC) or iDTF.</span>
nFreqs = 128;   <span class="comment">% Number of frequency points to consider</span>
d = asymp_pdc(u,A,pf,nFreqs,metric,alpha);
d.Tragct = Tr_gct;
d.pvaluesgct = pValue_gct;
</pre><h2 id="18">Information PDC plot</h2><pre class="codeinput">flgColor = 1;
[h,hxlabel,hylabel] = xplot(strID, d, <span class="keyword">...</span>
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale,flgMax,flgSignifColor);
xplot_title(alpha,metric,<span class="string">'PDC'</span>,strTitle);
</pre><img vspace="5" hspace="5" src="winterhalder2005_variant_03.png" alt=""> <h2 id="19">Remarks on false-positive connectivity detection ratio:</h2><div><ul><li>As 42 combinations of <b>PDC</b> and <b>GC</b> are tested, chances are that you     will see significant <img src="winterhalder2005_variant_eq09556325088033023315.png" alt="$|{PDC}(\lambda)|^2$"> (red lines), also in the     case of <img src="winterhalder2005_variant_eq09556325088033023315.png" alt="$|{PDC}(\lambda)|^2$"> (see above), in some plottings. The     significant <b>PDC</b> probability depends on significance level you have     chosen for null hypothesis PDC testing.</li><li>As stated before, the false-positive rate is approximately equal to the   chosen level of significance <img src="winterhalder2005_variant_eq14221827199139923399.png" alt="$\alpha$"> value.</li><li>The similar argument would apply for "instantaneous Granger causality"   outcomes evaluation, and the combination of 21 pairs of variables   should be considered as <b>iGC</b> is a symmetric relation in this case.</li></ul></div><h2 id="20">General remarks about xplot features:</h2><div><ul><li>When `flgColor=1` parameter option is used in the xplot.m routine, the y-axis intervals: (a) [0 .01] background is colored in <b>LIGHT-PURPLE</b>; (b) (.01 .1] in <b>LIGHT-BLUE</b>; and (c) (.1 1] is <b>WHITE</b>.</li></ul></div><div><ul><li>If the y-axis is scaled according to the maximum amplitude of the measures, this color coding may help easily getting clue about the magnitude <img src="winterhalder2005_variant_eq12280493672499922952.png" alt="$|{DTF}|^2$"> or <img src="winterhalder2005_variant_eq16963151017031281882.png" alt="$|{PDC}|^2$"> estimates.</li></ul></div><div><ul><li>If the background is <b>LIGHT-PURPLE</b>  one would know the maximum amplitude is smaller than 1/100, while with <b>LIGHT-BLUE</b> background is smaller than 1/10.</li></ul></div><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2020a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% WINTERHALDER ET AL.(2005) - 7-dimension unbalanced random independent variables UNBALANCED RANDOM INDEPENDENT VARIABLES
%
% Description:
%
% Expanded to seven variables and modified to consider unbalanced variances with idea borrowed from:
%  Winterhalder et al. Comparison of linear signal processing techniques to
%  infer directed interactions in multivariate neural systems. 
%  _Signal Processing_ 85:2137REPLACE_WITH_DASH_DASH2160, 2005.
% <http://dx.doi.org/10.1016/j.sigpro.2005.07.011>
%
%
% Example: Seven random independent variables with unbalanced variances.
% Variant of Random Independent Process with 7 variables') with following
% variances:
%
% $\sigma_1^2=\sigma_3^2=250,000; \sigma_2^2=\sigma_4^2=\sigma_5^2=\sigma_6^2=\sigma_7^2=1$
%
%
%% See also: mvar, mvarresidue, asymp_pdc, asymp_dtf, gct_alg, 
%              igct_alg, xplot, xplot_pvalues             
%
%%

% (C) Koichi Sameshima & Luiz A. Baccalá, 2022. 
% See file license.txt in installation directory for licensing terms.

%% Data sample generation

clear; clc; format compact; format short

flgPrintScreen = 'Screen'; %'Screen' or  'Print'

nBurnIn = 1000;    % number of points discarded at beginning of simulation
nPoints  = 5000;    % number of analyzed samples points

alpha  = 0.05;  % Significance level for PDC/DTF null hypothesis test

%% Data generation function:
u = fwinterhalder2005_variant(nPoints, nBurnIn);

chLabels = {'x_1';'x_2';'x_3';'x_4';'x_5';'x_6';'x_7'};%chLabels = [];
fs = 1; % Normalized sampling frequency 

%% PDC/DTF  estimation and analysis parameters

% Common routine segment for all examples

%% Data pre-processing: detrending and standardization options

flgDetrend = 1;     % 1: Detrending the data set
flgStandardize = 0; % 0: No standardization

% Checking data dimension
[nChannels,nSegLength] = size(u);
if nChannels > nSegLength
   u = u.'; 
   [nChannels,nSegLength] = size(u);
end

% Detrending 
if flgDetrend
   for i = 1:nChannels, u(i,:) = detrend(u(i,:)); end
   disp('Time series were detrended.');
end

% Standardization 
if flgStandardize
   for i = 1:nChannels, u(i,:) = u(i,:)/std(u(i,:)); end
   disp('Time series were scale-standardized.');
end;

%% MVAR model estimation

maxIP = 30;         % maximum model order to consider.
alg = 1;            % 1 = Nutall-Strand MVAR estimation algorithm
criterion = 1;      % 1 = AIC, Akaike Information Criteria

disp('Running MVAR estimation and GCT analysis routines.')

[IP,pf,A,pb,B,ef,eb,vaic,Vaicv] = mvar(u,maxIP,alg,criterion);

disp(['Number of channels = ' int2str(nChannels) ' with ' ...
    int2str(nSegLength) ' data points; MAR model order = ' int2str(IP) '.']);

%% Testing the adequacy of MAR model fitting through Portmanteau test

h = 20; % testing lag value
MVARadequacy_signif = 0.05; % VAR model estimation adequacy significance
                            % level
aValueMVAR = 1 - MVARadequacy_signif; % Confidence value for the testing

flgPrintResults = 1; % flag = 1, print analysis results

[Pass,Portmanteau,st,ths] = mvarresidue(ef,nSegLength,IP,aValueMVAR,h,...
                                           flgPrintResults);

%% Granger causality test (GCT) and instantaneous GCT

gct_signif  = alpha;  % Granger causality test significance level
igct_signif = alpha;  % Instantaneous GCT significance level


                 
flgPrintResults = 1; % Flag to control printing gct_alg.m results on command window.

[Tr_gct, pValue_gct] = gct_alg(u,A,pf,gct_signif,flgPrintResults);
[Tr_igct, pValue_igct] = igct_alg(u,A,pf,igct_signif,flgPrintResults);
                                                       
%% PDC, threshold and confidence interval calculations.
%
metric = 'euc';  % euc  = original PDC or DTF;
                 % diag = generalized PDC (gPDC) or DC;
                 % info = information PDC (iPDC) or iDTF.

nFreqs = 128;   % Number of frequency points to consider

%%
% PDC analysis results are saved in *c* data structure.
% See asymp_pdc.m or issue 
%
%   >> help asymp_pdc 
%
% command for more detail.

c = asymp_pdc(u,A,pf,nFreqs,metric,alpha);
    c.Tragct = Tr_gct;
    c.pvaluesgct = pValue_gct;

    
%% Plotting options set up, mostly cosmetic for xplot.m routine:
%

% flgColor parameter for PDC matrix-layout plot.
flgMax = 'all';
flgSignifColor = 4; % red + green
flgScale = 3;       % [0 1]/[0 .1]/[0 .01]
flgColor = [0];   % Plotting option for automatic scaling for small PDC
                  % values.
                  % if flgColor = 0, y-axis scale = [0 1]
                  % elseif flgColor = 1, xplot routine rescale 
                  % the y-axis automatically according to following rules:
                  %   If .001<= max(|PDC(f)|^2) < .01 background-color = light-blue,
                  %                          so that y-axis scale = [0 .1]
                  %   elseif max(|PDC(f)|^2) < .001 background-color = light-purple
                  %                          and y-axis = [0 .01].
%                [1 2 3 4 5 6 7]
flgPrinting  =   [1 0 1 0 3 0 0];
%       blue-line | | | | | | 7REPLACE_WITH_DASH_DASHSpectra (0: w/o; 1: Linear; 2: Log; 3: PDC2; 
%                 | | | | | |      4: Linear normalized; 5: Log spectra + PDC2)
%            gray | | | | | 6REPLACE_WITH_DASH_DASHCoh2 (0: w/o Coh2; 1: w Coh2)
% green or purple | | | | 5REPLACE_WITH_DASH_DASHPrint GCT results
%                 | | | 4REPLACE_WITH_DASH_DASHPlot confidence interval
%            red  | | 3REPLACE_WITH_DASH_DASHSignificant PDC2|DTF2 in red lines
%    dashed-black | 2REPLACE_WITH_DASH_DASHPatnaik threshold level in black dashed-lines
%           green 1REPLACE_WITH_DASH_DASH PDC2/DTF2 in green lines or black w/o statistics,
%                     See flgSignifColor bellow for line color selection.

w_max=fs/2;
strID = 'Winterhalder et al. Signal Processing 85:2137?60, 2005';
strTitle = [' Independent Gaussian Noise: \sigma_1=\sigma_3=500;' ...
                           ' \sigma_2 = \sigma_4 = \sigma_5 = 1'];

flgScale = 2;

%% Original PDC plot
%

[h,hxlabel,hylabel] = xplot(strID, c, ...
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale,flgMax,flgSignifColor);
xplot_title(alpha,metric,'PDC',strTitle);


%% 
% *Remarks on nonstandardized unbalanced noise analysis*:
% 
% * Note that in this example the time series were not standardized.
% * As a consequence, due to the high variance/power of channels
%   $x_1$ and $x_3$, $|{PDC}(\lambda)|^2$ from other channels reaching these channels are 
%   high, but
%   still in most cases not significant (represented by green lines).
% * The Patnaik thresholds plotted in dashed-lines may not be visible in these 
%   subplots because their values are well above  upper limit of scale 
%   range which is limited to [0 1] on y-axis.
%   


%% PDC p-values plot
%

flgPrinting  =   [1 1 1 2 3 0 0];
[hp,hxlabel,hylabel] = xplot_pvalues(strID, c, ...
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale);
xplot_title(alpha,metric,'p-value PDC',strTitle);


%%
% *Remarks on PDC p-values plots*:
% 
% * Obviously this will vary with the simulations, As we are dealing with 7
% channels, there are 42 combinations of pair of channels. For random
% Gaussian processes, most likely one will see occasional false-positive
% inference in a rate proportional to the chosen alpha, which is 5% in this
% example. So one would expect roughly 42*0.05 false-positive cases in each
% simulation.
% * One can see above each subplot the Granger causality test p-value
% printed in green (not significant) or purple with dot (significant GCT)
% that should agree or be approximately equal in magnitude in most cases
% with the PDC p-values (our experience) plotted in frequency domain.


%% Information PDC estimation and analysis parameters
% 
% If the metric is either 'diag' or 'info', the unbalanced noises are 
% ruled out or scaled in their formulation as you can see in 
% the information PDC calculation results shown
% bellow. Same consideration would apply for information PDC.
%
% Information PDC analysis results are saved in *d* struct variable.

metric = 'info'; % info = information PDC (iPDC) or iDTF.
nFreqs = 128;   % Number of frequency points to consider
d = asymp_pdc(u,A,pf,nFreqs,metric,alpha);
d.Tragct = Tr_gct;
d.pvaluesgct = pValue_gct;

%% Information PDC plot
%
flgColor = 1;
[h,hxlabel,hylabel] = xplot(strID, d, ...
                               flgPrinting,fs,w_max,chLabels,flgColor,flgScale,flgMax,flgSignifColor);
xplot_title(alpha,metric,'PDC',strTitle);

%% Remarks on false-positive connectivity detection ratio:
% 
% * As 42 combinations of *PDC* and *GC* are tested, chances are that you
%     will see significant $|{PDC}(\lambda)|^2$ (red lines), also in the
%     case of $|{PDC}(\lambda)|^2$ (see above), in some plottings. The
%     significant *PDC* probability depends on significance level you have
%     chosen for null hypothesis PDC testing.
% * As stated before, the false-positive rate is approximately equal to the
%   chosen level of significance $\alpha$ value.
% * The similar argument would apply for "instantaneous Granger causality"
%   outcomes evaluation, and the combination of 21 pairs of variables
%   should be considered as *iGC* is a symmetric relation in this case.
%


%% General remarks about xplot features:
%
% * When `flgColor=1` parameter option is used in the xplot.m routine, the
% y-axis intervals: (a) [0 .01] background is colored in *LIGHT-PURPLE*; (b) (.01 .1] in
% *LIGHT-BLUE*; and (c) (.1 1] is *WHITE*.
%
% * If the y-axis is scaled according to the maximum amplitude of the measures, 
% this color coding may help easily getting clue about the magnitude 
% $|{DTF}|^2$ or $|{PDC}|^2$ estimates.
%
% * If the background is *LIGHT-PURPLE*  one would know the maximum amplitude is
% smaller than 1/100, while with *LIGHT-BLUE* background is smaller than 1/10.
%

##### SOURCE END #####
--></body></html>